name: Publish ROS 2 Java Bindings Library

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        ros_distro: [jazzy, kilted]
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout Project (Workflow only)
        uses: actions/checkout@v4

      - name: Setup ROS 2
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ matrix.ros_distro }}

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'oracle'
          server-id: github

      - name: Install Jextract (JDK 25)
        run: |
          wget https://download.java.net/java/early_access/jextract/25/2/openjdk-25-jextract+2-4_linux-x64_bin.tar.gz
          tar -xf openjdk-25-jextract+2-4_linux-x64_bin.tar.gz
          echo "$(pwd)/jextract-25/bin" >> $GITHUB_PATH

      - name: Generate Bindings
        run: |
          source /opt/ros/${{ matrix.ros_distro }}/setup.bash
          mkdir -p src/main/java
          
          ROS_INC="/opt/ros/${{ matrix.ros_distro }}/include"
          
          jextract --output src/main/java \
            -t org.ros2.rcl \
            --header-class-name RclLib \
            -I $ROS_INC \
            -I $ROS_INC/rcl \
            -I $ROS_INC/rcutils \
            -I $ROS_INC/rmw \
            -I $ROS_INC/rcl_yaml_param_parser \
            -I $ROS_INC/rosidl_runtime_c \
            -I $ROS_INC/rosidl_typesupport_interface \
            -I $ROS_INC/type_description_interfaces \
            -I $ROS_INC/service_msgs \
            -I $ROS_INC/builtin_interfaces \
            -I $ROS_INC/rosidl_dynamic_typesupport \
            -I $ROS_INC/rosidl_dynamic_typesupport_fastrtps \
            $ROS_INC/rcl/rcl/rcl.h

          for PKG in std_msgs geometry_msgs std_srvs; do
            echo "Generating bindings for $PKG..."
            
            # Maak een tijdelijke wrapper header die alle .h bestanden uit de msg/srv map includeert
            TEMP_HEADER="master_$PKG.h"
            find $ROS_INC/$PKG/$PKG/msg $ROS_INC/$PKG/$PKG/srv -maxdepth 1 -name "*.h" 2>/dev/null | xargs -I {} echo '#include "{}"' > $TEMP_HEADER
            
            jextract --output src/main/java \
              -t org.ros2.rcl.msgs \
              --header-class-name ${PKG^^}_Lib \
              -I $ROS_INC \
              -I $ROS_INC/$PKG \
              -I $ROS_INC/rosidl_runtime_c \
              -I $ROS_INC/rosidl_typesupport_interface \
              -I $ROS_INC/builtin_interfaces \
              -I $ROS_INC/rcutils \
              -I $ROS_INC/fastcdr \
              -I $ROS_INC/std_msgs \
              $TEMP_HEADER
              
            rm $TEMP_HEADER
          done

      - name: Create POM file
        run: |
          cat <<EOF > pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.github.${{ github.repository_owner }}</groupId>
            <artifactId>ros2-java-bindings-${{ matrix.ros_distro }}</artifactId>
            <version>25.0.${{ github.run_number }}</version>
            <properties>
              <maven.compiler.source>25</maven.compiler.source>
              <maven.compiler.target>25</maven.compiler.target>
              <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
            </properties>
            <distributionManagement>
              <repository>
                <id>github</id>
                <url>https://maven.pkg.github.com/${{ github.repository }}</url>
              </repository>
            </distributionManagement>
          </project>
          EOF

      - name: Build and Publish to GitHub Packages
        run: mvn deploy -DskipTests --batch-mode
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create and Push Tag
        run: |
          TAG_NAME="${{ matrix.ros_distro }}-25.0.${{ github.run_number }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $TAG_NAME
          git push origin $TAG_NAME
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}